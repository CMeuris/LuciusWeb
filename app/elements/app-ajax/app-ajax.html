<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">

<polymer-element name="app-ajax" extends="core-ajax"
  attributes="url"
  handleAs="json"
  on-core-response="{{handleResponse}}">

  <script>
    (function() {
      Polymer({
        sort: true,
        noisePercentage: 0.01,

        // handle Response from ajax call
        handleResponse: function(e) {
          e.stopImmediatePropagation();

          var json = e.detail.response;
          app.data = [];

          if (json.status === 'ERROR') {
            console.log(json);
            window.alert('There where issues with the signature provided.' +
              'Please verify it and retry.');
          } else {
            app.data = json.result;

            // [SortedID:Number, ZhangScore:Number, ID:Number, PWIDs:String]

            // add noise to the values
            var plotNoise = Math.trunc(app.data.length * this.noisePercentage * app.settings.plotNoise);
            var plotNoise2 = plotNoise * 2;

            var hist2dNoise = Math.trunc(app.data.length * this.noisePercentage * app.settings.hist2dNoise);
            var hist2dNoise2 = hist2dNoise * 2;

            var i = app.data.length;
            while (i--) {
              app.data[i][4] = app.data[i][0] + (Math.random() * hist2dNoise2 - hist2dNoise);
              app.data[i][0] = app.data[i][0] + (Math.random() * plotNoise2 - plotNoise);
            }

            app.dataTop = [].concat(
              app.data.slice(0, app.settings.topComps),
              app.data.slice(app.data.length - app.settings.topComps, app.data.length)
            );

            this._fireAjaxDataReady();

            this.fire('core-signal', {
              name: 'update-hist-data'
            });
          }
        },

        toggleSort: function() {
          this._fireAjaxDataReady();
        },

        _fireAjaxDataReady: function() {
          this.fire('core-signal', {
            name: 'ajax-data-ready',
            data: {sort: this.sort}
          });
        }
      });
    })();
</script>
</polymer-element>
