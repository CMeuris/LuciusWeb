<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/core-input/core-input.html">
<link rel="import" href="../../bower_components/core-icons/core-icons.html">
<link rel="import" href="../../bower_components/core-menu/core-menu.html">
<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">

<link rel="import" href="../app-ajax/app-ajax.html">
<link rel="import" href="../compass-icons/compass-icons.html">

<polymer-element
  name="app-search-bar"
  flex layout horizontal>

  <template>
    <link rel="stylesheet" href="app-search-bar.css">

    <div class="box jnj">
      <div class="icon">
        <core-icon icon="compass-icons:lab"></core-icon>
      </div>

      <input id="compinput" class="input"
        is="core-input"
        list="datalist"
        placeholder="Compound">
      <datalist id="datalist">
        <!--
        NOTE: find a better autocomplete display. paper-typeahead-input in Polymer 1.0
        -->
        <option template repeat="{{compDatalist}}">{{}}</option>
      </datalist>
    </div>

    <div class="box gene" flex>
      <div class="icon">
        <core-icon icon="compass-icons:dna"></core-icon>
      </div>

      <input id="siginput" class="input"
        is="core-input"
        placeholder="Signature"
        value="{{signature}}"
        committedvalue="{{sigCommittedValue}}">
    </div>

    <div class="box toggle" layout horizontal>
      <div class="icon">
        <core-icon icon="sort"></core-icon>
      </div>

      <div class="container">
        <paper-toggle-button
          id="toggleSort"
          on-change="{{toggleSort}}"
          checked?="{{sort}}">
        </paper-toggle-button>
      </div>
    </div>

    <div class="box toggle" layout horizontal>
      <div class="icon">
        <core-icon icon="filter-list"></core-icon>
      </div>

      <div class="container">
        <paper-toggle-button
          id="toggleFilter"
          on-change="{{toggleFilter}}"
          checked?="{{filter}}">
        </paper-toggle-button>
      </div>
    </div>

    <app-ajax
      id="zhangAjax"
      method="POST"
      body="query={{signature}}
            sorted=true"></app-ajax>

    <core-ajax
      id="compAjax"
      method="POST"
      handleAs="json"
      body="select = 1"
      on-core-response="{{handleCompResponse}}">

    <core-ajax
      id="sigAjax"
      method="POST"
      handleAs="json"
      on-core-response="{{handleSigResponse}}">

  </template>

  <script>
    (function() {
      Polymer({
        // attributes
        signature: '',
        sort: true,
        filter: false,

        compounds: [],
        compDatalist: [],

        compTop: 20,
        compMinChars: 1,

        ready: function() {
          var url = app.settings.url + '?' + app.settings.queryString;

          this.signature = app.signature;

          this.$.zhangAjax.url = url + '&classPath=' + app.settings.classPath + '.zhang';
          this.$.compAjax.url = url + '&classPath=' + app.settings.classPath + '.compounds';
          this.$.sigAjax.url = url + '&classPath=' + app.settings.classPath + '.signature';

          this.$.compAjax.go();
          this.fire('core-signal', { name: 'start-loader' });

          this.$.compinput.addEventListener('input', this.handleCompInput.bind(this));
          this.$.compinput.addEventListener('keyup', this.handleCompKeyup.bind(this));
        },

        handleCompInput: function() {
          var count = 1;
          var value = this.$.compinput.value.toUpperCase();

          this.compDatalist = [];

          if (value && value.length > this.compMinChars) {
            for (var i in this.compounds) {
              if (this.compounds[i][0].indexOf(value, 0) >= 0) {
                this.compDatalist[i] = this.compounds[i][0];
                count++;
              }
              if (count >= this.compTop) {
                break;
              }
            }
          }
        },

        handleCompKeyup: function(e) {
          var val = this.$.compinput.value;

          if (e.keyCode === 13 && val.length > this.compMinChars && val !== '') {
            this.$.compinput.blur();
            this.$.sigAjax.body = 'compound = ' + val;
            this.$.sigAjax.go();

            app.compound = val;
            this.fire('core-signal', {
              name: 'compound-changed',
              data: val
            });
          }
        },

        handleCompResponse: function(e) {
          e.stopImmediatePropagation();

          var json = e.detail.response;

          if (json.status === 'ERROR') {
            console.error(json);
          } else {
            this.compounds = json.result;
          }
        },

        handleSigResponse: function(e) {
          e.stopImmediatePropagation();

          var json = e.detail.response;

          if (json.status === 'ERROR') {
            window.alert('Compound might be incomplete or incorrect. \n' +
              'Please verify it and retry.');
          } else {
            this.signature = app.signature = json.result.join(' ');
            this.$.zhangAjax.sort = this.sort;
            this.$.zhangAjax.go();
            this.fire('core-signal', { name: 'start-loader' });
          }
        },

        sigCommittedValueChanged: function() {
          this.$.siginput.blur();
          this.$.zhangAjax.sort = this.sort;
          this.$.zhangAjax.go();
          this.fire('core-signal', { name: 'start-loader' });
        },

        toggleSort: function() {
          this.sort = this.$.toggleSort.checked;
          this.$.zhangAjax.sort = this.sort;
          this.$.zhangAjax.toggleSort();
        },

        toggleFilter: function() {
          this.filter = this.$.toggleFilter.checked;
          // do something...
        }

      });
    })();
</script>
</polymer-element>
