<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/core-signals/core-signals.html">

<link rel="import" href="../graph-base/graph-base.html">

<polymer-element
  name="graph-histogram"
  extends="graph-base">

  <template>
    <!-- pubsub handler -->
    <core-signals
      on-core-signal-update-hist-data="{{handleUpdateHistData}}"
    </core-signals>

    <link rel="stylesheet" href="graph-histogram.css">
    <shadow></shadow>

    <core-ajax
      id="histAjax"
      method="POST"
      handleAs="json"
      on-core-response="{{handleHistAjaxResponse}}">

  </template>

  <script>
    (function() {
      Polymer({
        // config
        margin:       {top: 16, right: 48, bottom: 16, left: 8},
        padding:      {top: 16, right: 24, bottom: 16, left: 24},
        bins:         16,
        targetGene:   '',
        geneData:     [],
        dataBounds:   [],
        data:         [],

        yScale:       null,
        xScale:       null,
        yAxis:        null,
        yAxisGroup:   null,
        xAxis:        null,
        xAxisGroup:   null,
        colorScale:   null,
        barSelected:  null,
        barSize:      0,
        barGap:       2,

        // ready : inherited
        ready: function() {
          this.super();
          this.bins = app.settings.histBins;
        },

        handleAjaxData: function() {
          // override super() and do nothing
        },

        handleFilterData: function() {
          // override super() and do nothing
        },

        handleUnfilterData: function() {
          d3.select(this.barSelected).classed('selected', false);
          this.barSelected = null;
        },

        handleUpdateHistData: function(e, data) {
          this.targetGene = data ? data : '';

          var req = this.$.histAjax;
          req.url = app.settings.url + '?' +
                    app.settings.queryString +
                    '&classPath=' + app.settings.classPath + '.targetHistogram';
          req.body = 'bins = ' + this.bins + '\n' +
                     'features = zhang ' + data + '\n' +
                     'query = ' + app.signature;
          req.go();
        },

        handleHistAjaxResponse: function(e) {
          e.stopImmediatePropagation();

          var json = e.detail.response.result;

          if (json.status === 'ERROR') {
            console.log(json);
            console.error('ERROR in the call!');
          } else {
            this.dataBounds = json.metadata.bounds;
            this.data = json.data.zhang;
            this.geneData = this.targetGene.length ?
                            json.data[this.targetGene] : [];

            this.isDataReady = true;
            this.isDataNew = true;
            this.handlePrepare();
          }
        },

        initAxis: function() {
          this.super();

          this.yAxis = d3.svg.axis();
          this.yAxisGroup = this.svg.append('g')
            .attr('class', 'y axis');
        },

        updateValues: function() {
          this.super();

          this.barSize = Math.floor(this.gHeightPad / this.bins);
        },

        updateScales: function() {
          this.super();

          var dataSize = this.data.length-1;

          this.yAxisScale = d3.scale.linear()
            .domain([1, -1])
            .range([0, this.gHeightPad]);

          this.yScale = d3.scale.linear()
            .domain([0, dataSize])
            .range([0, this.gHeightPad]);

          this.xScale = d3.scale.linear()
            .domain([0, d3.max(this.data)])
            .range([0, this.gWidthPad]);

          this.colorScale = d3.scale.linear()
            .domain([0, 0.25*dataSize, 0.5*dataSize, 0.75*dataSize, dataSize])
            .range(this.colors);
        },

        updateGraph: function() {
          this.super();

          var _this = this;

          // draw Background
          this.bg
            .attr('width', this.gWidth)
            .attr('height', this.gHeight)
            .attr('transform', 'translate(' +
              this.margin.left + ', ' +
              this.margin.top + ')');

          // draw Axis
          this.yAxis.scale(this.yAxisScale)
            .orient('right')
            .tickSize(this.gWidth);

          this.yAxisGroup
            .attr('transform', 'translate(' +
              this.margin.left + ',' +
              (this.margin.top + this.padding.top) + ')')
            .call(this.yAxis);

          // draw graph
          this.g.attr('transform', 'translate(' +
            (this.margin.left + this.padding.left) + ',' +
            (this.margin.top + this.padding.top - (this.barSize / 2) + (this.barGap / 2)) + ')');

          // Stop execution if data is not ready
          if (!this.isDataReady) {
            return true;
          }

          function drawHistogram(selection, selector, fill) {
            selection.enter().append('rect');

            selection.attr('class', selector)
              .attr('x', function(d) { return _this.gWidthPad - _this.xScale(d); })
              .attr('y', function(d, i) { return _this.yScale(i); })
              .attr('height', _this.barSize - _this.barGap)
              .attr('width', function(d) {
                return d > 0 ? _this.xScale(d) + _this.padding.left - 1 : 0;
              });

            if (fill) {
              selection
                .attr('fill', function(d, i) { return _this.colorScale(i); });
            }

            selection.exit().remove();
          }

          if (this.geneData.length) {
            this.g.selectAll('.genebar')
              .data(this.geneData)
              .call(drawHistogram, 'genebar', false);
          } else {
            this.g.selectAll('.genebar').remove();
          }

          var bars = this.g.selectAll('.bar')
            .data(this.data)
            .call(drawHistogram, 'bar', true);

          bars.on('mouseover', function() {
            d3.select(this).classed('hover', true);
          });
          bars.on('mouseout', function() {
            d3.select(this).classed('hover', false);
          });
          bars.on('click', function(d, i) {
            _this.fire('core-signal', {
              name: 'filter-data',
              data: { bounds: _this.dataBounds[i] }
            });

            if (_this.barSelected) {
              d3.select(_this.barSelected).classed('selected', false);
            }
            _this.barSelected = this;
            d3.select(_this.barSelected).classed('selected', true);
          });

          this.bg.on('click', function() {
            _this.fire('core-signal', {
              name: 'unfilter-data',
              data: null
            });

            if (_this.barSelected) {
              d3.select(_this.barSelected).classed('selected', false);
              _this.barSelected = null;
            }
          });

          if (_this.barSelected && this.targetGene) {
            d3.select(_this.barSelected).classed('selected', true);
          }

          this.isDataNew = false;
        }
      });
    })();
</script>
</polymer-element>
