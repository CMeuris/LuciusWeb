<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/core-signals/core-signals.html">

<polymer-element
  name="graph-word-hist"
  attributes="bindata brushdata">

  <template>
    <!-- pubsub handler -->
    <core-signals
      on-core-signal-compound-changed="{{handleCompoundChanged}}">
    </core-signals>

    <link rel="stylesheet" href="graph-word-hist.css">

    <div class="header" layout horizontal>
      <div flex>
        Known targets&nbsp;
        <template if="{{showCompound}}">
          <span>for </span><span class="compound">{{compound}}</span>
        </template>
      </div>
      <template if="{{showTargetGene}}">
        <div class="target_lable">Selected target:</div>
        <div class="target">{{targetGene}}</div>
      </template>
    </div>

    <div id="words">
      <template if="{{empty}}">
        <div class="empty">No targets</div>
      </template>
    </div>

    <core-ajax
      id="ajaxCompounds"
      method="POST"
      handleAs="json"
      on-core-response="{{handleCompoundsResponse}}">

    <core-ajax
      id="ajaxTargets"
      method="POST"
      handleAs="json"
      on-core-response="{{handleTargetsResponse}}">

  </template>

  <script>
    (function() {
      Polymer({
        brushdata: [],
        bindata: [],

        hasCompound: false,
        showCompound: false,
        showTargetGene: false,
        targetGene: '',
        compound: '',
        pwids: '',
        pwidsComp: '',
        empty: false,

        ready: function() {
          //
        },

        handleCompoundChanged: function(e) {
          this.showTargetGene = false;
          this.hasCompound = true;
          this.compound = e.detail;

          this.$.ajaxCompounds.url = app.settings.url + '?' +
            app.settings.queryString +
            '&classPath=' + app.settings.classPath + '.compounds';
          this.$.ajaxCompounds.body = 'query = ' + e.detail;
          this.$.ajaxCompounds.go();
        },

        handleCompoundsResponse: function(e) {
          e.stopImmediatePropagation();

          var json = e.detail.response.result;

          if (json.status === 'ERROR') {
            console.log(json);
            console.error('ERROR in the call!');
          } else {
            var data = json[0][1];

            this.pwidsComp = '';
            for (var i = 0; i < data.length; i++) {
              this.pwidsComp += data[i] + ' ';
            }
            this.updateValues(this.pwidsComp);
            this.showCompound = true;
          }
        },

        bindataChanged: function() {
          if (this.bindata.length && !this.brushdata.length) {
            this.binOrBrushDataChanged(this.bindata);
          }
        },

        brushdataChanged: function() {
          if (this.brushdata.length) {
            this.binOrBrushDataChanged(this.brushdata);
          } else {
            this.binOrBrushDataChanged(this.bindata);
          }
        },

        binOrBrushDataChanged: function(data) {
          if (data.length || !this.hasCompound) {
            this.pwids = '';
            for (var i = 0; i < data.length; i++) {
              this.pwids += data[i][3] + ' ';
            }
            this.updateValues(this.pwids);
            this.showCompound = false;
          } else {
            this.updateValues(this.pwidsComp);
            this.showCompound = true;
          }
        },

        updateValues: function(pwids) {
          this.$.ajaxTargets.url = app.settings.url + '?' +
            app.settings.queryString +
            '&classPath=' + app.settings.classPath + '.targetFrequency';
          this.$.ajaxTargets.body = pwids.length ? 'pwids = ' + pwids : '';
          this.$.ajaxTargets.go();
        },

        handleTargetsResponse: function(e) {
          e.stopImmediatePropagation();

          var json = e.detail.response.result;

          if (json.status === 'ERROR') {
            console.log(json);
            console.error('ERROR in the call!');
          } else {
            var data = json.slice(0, 48);
            this.updateGraph(data);
          }
        },

        updateGraph: function(data) {
          this.empty = data.length ? false : true;

          var wordsColumns = 4;
          var boxHeight = 32;
          var boxWidth = Math.floor(100/wordsColumns) + '%';

          var domainMax = data.length ? data[0][1] : 10;
          var xScale = d3.scale.linear()
            .domain([1, domainMax])
            .range([1, 100]);

          var words = d3.select(this.$.words);
          var box = words.selectAll('.box')
            .data(data);

          box.enter().append('div');

          box
            .attr('class', 'box')
            .style('height', boxHeight + 'px')
            .style('width',  boxWidth)
            .html(function(d) {
              return '<div class="word">' + d[0] + '</div><div class="bar"><span class="bar" style="width:' + xScale(d[1]) + '%"></span><span class="num">' + d[1] + '</span></div>';
            });

          var prevSelection;
          var _this = this;

          box.on('click', function(d) {
            _this.targetGene = d[0];
            _this.showTargetGene = true;

            d3.select(this).classed('selected', true);
            d3.select(prevSelection).classed('selected', false);
            prevSelection = this;

            _this.fire('core-signal', {
              name: 'update-hist-data',
              data: _this.targetGene
            });
          });

          box.exit().remove();

          if (!this.empty) {
            // Height of #words must be a multiple of the columns + 32px of padding
            var wordsHeight = Math.ceil(data.length / wordsColumns) * boxHeight + 32;
            words.style('height', wordsHeight + 'px');
          } else {
            words.style('height', 'inherit');
          }
        }
      });
    })();
</script>
</polymer-element>
